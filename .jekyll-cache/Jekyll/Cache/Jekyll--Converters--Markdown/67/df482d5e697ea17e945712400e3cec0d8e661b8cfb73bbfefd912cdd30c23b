I"}0<div class="row">
  <div class="col grid s12 m6 l3">
    <img src="/images/mapbox.png" class="responsive-img" />
  </div>
  <div class="col grid s12 m6 l9 ">
    Mapbox GL JS is a web mapping library based on WebGL.<br />
    <br />
    Using Mapbox GL JS for serving tilesets is an interesting option especially if rendering a map on the fly in the client web browser is what you are looking for. This ability allows you to render efficiently data-driven map. 
  </div>
</div>

<p>The below instructions detail the process for a RHEL/CentOS 7 Linux distribution.</p>

<h2 id="prerequisites">Prerequisites</h2>

<h4 id="install-proj4">Install proj.4</h4>
<ul>
  <li>GitHub repo: <a href="https://github.com/OSGeo/proj.4">https://github.com/OSGeo/proj.4</a></li>
  <li>Website: <a href="https://proj4.org/">https://proj4.org/</a></li>
</ul>

<p>PROJ is a generic coordinate transformation software, that transforms coordinates from one coordinate reference system (CRS) to another. This includes cartographic projections as well as geodetic transformations.</p>

<p>proj.4 installation from source</p>
<pre><code class="language-bash">git clone https://github.com/OSGeo/proj.4
cd proj.4
./autogen.sh
./configure
make
sudo make install
</code></pre>

<h4 id="install-expat-and-sqlite">Install Expat and SQLite</h4>

<ul>
  <li>Expat is a C library for parsing XML, started by James Clark in 1997</li>
  <li>Development tools for the sqlite3 embeddable SQL database engine</li>
</ul>

<pre><code class="language-bash">sudo yum install expat sqlite-devel
</code></pre>

<h2 id="install-gdal-and-tippecanoe">Install GDAL and TippeCanoe</h2>

<h4 id="gdal">GDAL</h4>
<p><b>GDAL</b> is a translator library for raster and vector geospatial data formats that is released under an <a href="http://trac.osgeo.org/gdal/wiki/FAQGeneral#WhatlicensedoesGDALOGRuse">X/MIT</a> style <a href="http://www.opensource.org/">Open Source</a> license by the <a href="http://www.osgeo.org/">Open Source Geospatial Foundation</a>.</p>

<p><i>(GDAL must be installed with SQLite and Expat support.)</i></p>

<p>Download last GDAL from: <a href="http://trac.osgeo.org/gdal/wiki/DownloadSource">http://trac.osgeo.org/gdal/wiki/DownloadSource</a></p>

<p>Install GDAL</p>
<pre><code class="language-bash">./configure
make
sudo make install
</code></pre>

<p>Make GDAL tools accessible by adding <code>/usr/local/lib64</code> to LD_LIBRARY_PATH</p>
<pre><code class="language-bash">export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib64
</code></pre>

<p>Check ogr2ogr gdal tool version</p>
<pre><code class="language-bash">ogr2ogr --version
GDAL 2.3.1, released 2018/06/22
</code></pre>

<h4 id="tippecanoe">Tippecanoe</h4>
<p>Tippecanoe enable to build vector tilesets from large collections of GeoJSON features.</p>

<p>Install Tippecanoe</p>
<pre><code class="language-bash">git clone https://github.com/mapbox/tippecanoe
cd tippecanoe
make
sudo make install
</code></pre>

<h2 id="generate-your-own-vector-tiles">Generate Your Own Vector Tiles</h2>

<p>Download any OpenStreetMap .pbf file you would like to render.</p>

<pre><code class="language-bash">wget https://download.geofabrik.de/europe/great-britain/england/greater-london-latest.osm.pbf
</code></pre>

<p>The .pbf file itself can be thought of as a database. GDAL (ogr2ogr) will automatically view the .pbf as having 5 tables: <b>points</b>, <b>lines</b>, <b>multipolygons</b>, <b>multilinestrings</b> (routes), <b>other_relations</b> (osm relations). The <b>osmconf.ini</b> file tells GDAL what columns you want in your tables. Columns are the key name from key=value tag pairs in OSM. (<b>Source</b>: <a href="https://wiki.openstreetmap.org/wiki/User:Bgirardot/How_To_Convert_osm_.pbf_files_to_Esri_Shapefiles">User:Bgirardot/How To Convert osm .pbf files to Esri Shapefiles</a>)</p>

<p>My <b>osmconf.ini</b> file define the <b>[lines]</b> information that way:</p>

<pre><code class="language-bash">[lines]
# common attributes
osm_id=yes
osm_version=no
osm_timestamp=no
osm_uid=no
osm_user=no
osm_changeset=no

# keys to report as OGR fields
attributes=name,highway,waterway,aerialway,barrier,man_made

# type of attribute 'foo' can be changed with something like
#foo_type=Integer/Real/String/DateTime

# keys that should NOT be reported in the "other_tags" field
ignore=created_by,converted_by,source,time,ele,note,openGeoDB:,fixme,FIXME
# uncomment to avoid creation of "other_tags" field
#other_tags=no
# uncomment to create "all_tags" field. "all_tags" and "other_tags" are exclusive
#all_tags=yes

#computed_attributes must appear before the keywords _type and _sql
computed_attributes=z_order
z_order_type=Integer
# Formula based on https://github.com/openstreetmap/osm2pgsql/blob/master/style.lua#L13
# [foo] is substituted by value of tag foo. When substitution is not wished, the [ character can be escaped with \[ in literals
# Note for GDAL developers: if we change the below formula, make sure to edit ogrosmlayer.cpp since it has a hardcoded optimization for this very precise formula
z_order_sql="SELECT (CASE [highway] WHEN 'minor' THEN 3 WHEN 'road' THEN 3 WHEN 'unclassified' THEN 3 WHEN 'residential' THEN 3 WHEN 'tertiary_link' THEN 4 WHEN 'tertiary' THEN 4 WHEN 'secondary_link' THEN 6 WHEN 'secondary' THEN 6 WHEN 'primary_link' THEN 7 WHEN 'primary' THEN 7 WHEN 'trunk_link' THEN 8 WHEN 'trunk' THEN 8 WHEN 'motorway_link' THEN 9 WHEN 'motorway' THEN 9 ELSE 0 END) + (CASE WHEN [bridge] IN ('yes', 'true', '1') THEN 10 ELSE 0 END) + (CASE WHEN [tunnel] IN ('yes', 'true', '1') THEN -10 ELSE 0 END) + (CASE WHEN [railway] IS NOT NULL THEN 5 ELSE 0 END) + (CASE WHEN [layer] IS NOT NULL THEN 10 * CAST([layer] AS INTEGER) ELSE 0 END)"
</code></pre>

<p>Convert .osm.pbf data to GeoJSON format specifying the layer of data to extract, here: <b>lines</b></p>
<pre><code class="language-bash">ogr2ogr -f 'GeoJSON' -s_srs 'EPSG:4326' -t_srs 'EPSG:4326' 'Greater London.json' 'Greater_London.osm.pbf' lines
</code></pre>

<p>Having our data in a GeoJSON file, we can generate tiles that way:</p>
<pre><code class="language-bash">tippecanoe --no-feature-limit --no-tile-size-limit --include={"osm_id","highway"} --maximum-zoom=16 --output-to-directory "Greater_London" 'Greater_London.json'
</code></pre>

<p>Check how your data has been encoded inside a tile (having a tile/a file: ./Greater_London/8/127/84.pbf, I want to read the first 500 characters)</p>
<pre><code class="language-bash">tippecanoe-decode ./Greater_London/8/127/84.pbf 8 127 82 | head -c 500
</code></pre>

<p>I get <i>(The output below has been formatted after the command)</i></p>
<pre><code class="language-javascript">{
   "type":"FeatureCollection",
   "properties":{
      "zoom":8,
      "x":127,
      "y":82
   },
   "features":[
      {
         "type":"FeatureCollection",
         "properties":{
            "layer":"Greater_London",
            "version":2,
            "extent":4096
         },
         "features":[
            {
               "type":"Feature",
               "properties":{
                  "osm_id":"3702620",
                  "highway":"residential"
               },
               "geometry":{
                  "type":"LineString",
                  "coordinates":[[-0.499535,53.343583],[-0.501251,53.344813],[-0.502625,53.347272],[-0.504341,53.347887]]
               }
            },
            {
               "type":"Feature",
               "properties":
</code></pre>

<h2 id="render-your-tiles-with-mapbox-gl-javascript-library">Render your tiles with Mapbox GL JavaScript library</h2>

<p>Under your web server directory create a new directory</p>
<pre><code class="language-bash">mkdir serving_custom_tiles_demo
</code></pre>

<p>In it edit an <b>index.html</b> file</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset="utf-8" /&gt;
  &lt;title&gt;Map&lt;/title&gt;
  &lt;meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" /&gt;
    &lt;script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'&gt;&lt;/script&gt;
    &lt;link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' /&gt;
  &lt;style&gt;
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div id="map"&gt;&lt;/div&gt;
  &lt;script&gt;
    mapboxgl.accessToken = "not-needed-unless-using-mapbox-styles";
    var map = new mapboxgl.Map({
        container: "map",
        style: "base_style.json",
        center: [0.1278, 51.5074], // center of London
        minZoom: 5,
        zoom: 13,
        maxZoom: 16
    });
    map.addControl(new mapboxgl.NavigationControl());
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>Move your tiles previously generated under your web server directory, making your tiles reachable in the browser from: <a href="http://localhost/tiles/Greater_London/8/127/84.pbf">http://localhost/tiles/Greater_London/{z}/{x}/{y}.pbf</a></p>

<p>Edit also a Javascript file <b>base_style.json</b> defining your custom rendering style:</p>
<pre><code class="language-javascript">{
  "version": 8,
  "name": "Custom",
  "metadata": {
    "mapbox:autocomposite": true
  },
  "sources": {
    "composite": {
      "type": "vector",      
      "tiles": [
        "http://localhost/tiles/Greater_London/{z}/{x}/{y}.pbf"
      ],
      "minzoom": 0,
      "maxzoom": 15
    }
  },
 "layers": [
    {
      "id": "background",
      "type": "background",
      "paint": {
        "background-color": "#e3decb"
      }
    },
  {
            "interactive": true,
            "layout": {
                "line-cap": "butt",
                "line-join": "miter"
            },
            "filter": [
                "all",
                [
                    "==",
                    "$type",
                    "LineString"
                ],
                [
                    "all",
                    [
                        "in",
                        "highway",
                        "motorway",
                        "motorway_link",
                        "primary",
                        "primary_link ",
                        "secondary",
                        "secondary_link ",
                        "residential",
                        "tertiary",
                        "tertiary_link ",
                        "trunk",
                        "trunk_link",
                        "street",
                        "street_limited",
                        "service",
                        "track",
                        "pedestrian",
                        "path",
                        "link"
                    ]
                ]
            ],
            "type": "line",
            "source": "composite",
            "id": "tunnel_minor",
            "paint": {
                "line-color": "#efefef",
                "line-width": {
                    "base": 1.55,
                    /***
                    *  Zoom functions allow the appearance of a map feature to change with map’s zoom level. 
                    *  Zoom functions can be used to create the illusion of depth and control data density. 
                    *  Each stop is an array with two elements: the first is a zoom level and the second is 
                    *  a function output value.
                    ***/
                    "stops": [
                    	// zoom is 4 -&gt; the line width will be 0.25px
                        [4, 0.25],
                        // zoom is 20 -&gt; the line width will be 30px
                        [20, 30]
                    ]
                }
            },
            "source-layer": "Greater_London"
        }
  ]
}
</code></pre>

<p>Check <a href="https://www.mapbox.com/mapbox-gl-js/style-spec">Mapbox Style Specification</a> to know more about the above properties used.</p>

<p>Notice that the source-layer property should correspond to the layer property seen before in a .pbf tile.</p>

<p>If Apache can read your tiles you should be able to see a rendering of it in a web browser at: <a href="http://localhost/serving_custom_tiles_demo">http://localhost/serving_custom_tiles_demo</a></p>

<p><img src="/images/04-build-tiles-from-osm-pbf-file/01-build-tiles-from-osm-pbf-file.png" class="responsive-img" /></p>
:ET